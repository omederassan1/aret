<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>📒 ديون العملاء</title>
  <style>
    body {
      font-family: "Cairo", sans-serif;
      background: linear-gradient(135deg, #3f51b5, #2196f3);
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .card {
      background: #fff;
      color: #333;
      border-radius: 20px;
      padding: 20px;
      width: 90%;
      max-width: 450px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    button {
      width: 100%;
      margin: 8px 0;
      padding: 14px;
      font-size: 18px;
      background: #2196f3;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { background: #1976d2; }
    select, input, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    h2, h3 { margin-bottom: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <h2>📒 إدارة ديون العملاء</h2>

    <div id="mainMenu">
      <button onclick="show('addDebt')">➕ إضافة دين</button>
      <button onclick="show('payDebt')">💰 قبض دين</button>
      <button onclick="show('statement')">📄 كشف حساب</button>
      <button onclick="show('addClient')">👤 إضافة عميل</button>
    </div>

    <div id="addDebt" class="hidden">
      <h3>إضافة دين</h3>
      <select id="debtClient"></select>
      <input type="number" id="debtAmount" placeholder="المبلغ">
      <textarea id="debtNote" placeholder="ملاحظة"></textarea>
      <button onclick="sendTransaction('دين')">إضافة</button>
      <p id="debtMsg"></p>
      <button onclick="back()">⬅️ رجوع</button>
    </div>

    <div id="payDebt" class="hidden">
      <h3>قبض دين</h3>
      <select id="payClient"></select>
      <input type="number" id="payAmount" placeholder="المبلغ">
      <textarea id="payNote" placeholder="ملاحظة"></textarea>
      <button onclick="sendTransaction('قبض')">قبض</button>
      <p id="payMsg"></p>
      <button onclick="back()">⬅️ رجوع</button>
    </div>

    <div id="statement" class="hidden">
      <h3>كشف حساب</h3>
      <select id="clientList" onchange="getStatement()"></select>
      <div id="statementData"></div>
      <button onclick="back()">⬅️ رجوع</button>
    </div>

    <div id="addClient" class="hidden">
      <h3>إضافة عميل</h3>
      <input type="text" id="newClient" placeholder="اسم العميل">
      <button onclick="addClient()">إضافة</button>
      <p id="clientMsg"></p>
      <button onclick="back()">⬅️ رجوع</button>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx6TYknUEt61F2_Vfpp9W4xpAGUWy25QJEZRgrtO1FZ05AGGPZQ6G2zWJ-WZ05zcZCpag/exec"; // ← ضع هنا رابط Google Script

    async function api(data) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });
      return await res.json();
    }

    function show(id) {
      document.querySelectorAll('.card > div').forEach(d => d.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      loadClients();
    }

    function back() {
      document.querySelectorAll('.card > div').forEach(d => d.classList.add('hidden'));
      document.getElementById('mainMenu').classList.remove('hidden');
    }

    async function loadClients() {
      const clients = await api({action: 'getClients'});
      ['debtClient','payClient','clientList'].forEach(id=>{
        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = '<option value="">اختر العميل</option>';
        clients.forEach(c=>{
          const opt = document.createElement('option');
          opt.value = c; opt.textContent = c;
          sel.appendChild(opt);
        });
      });
    }

    async function sendTransaction(type) {
      const isDebt = type === 'دين';
      const client = document.getElementById(isDebt ? 'debtClient':'payClient').value;
      const amount = document.getElementById(isDebt ? 'debtAmount':'payAmount').value;
      const note = document.getElementById(isDebt ? 'debtNote':'payNote').value;
      const msg = document.getElementById(isDebt ? 'debtMsg':'payMsg');
      if (!client || !amount) return msg.textContent = '❗الرجاء تعبئة جميع الحقول';
      msg.textContent = '⏳ جاري الإضافة...';
      const res = await api({action:'addTransaction', client, amount, note, type});
      msg.textContent = res;
    }

    async function addClient() {
      const name = document.getElementById('newClient').value.trim();
      const msg = document.getElementById('clientMsg');
      if (!name) return msg.textContent = '❗الرجاء إدخال الاسم';
      msg.textContent = '⏳ جاري الإضافة...';
      const res = await api({action:'addClient', name});
      msg.textContent = res;
    }

    async function getStatement() {
      const client = document.getElementById('clientList').value;
      const div = document.getElementById('statementData');
      if (!client) return div.innerHTML = '';
      div.innerHTML = '⏳ جاري التحميل...';
      const data = await api({action:'getStatement', client});
      if (!data.length) return div.innerHTML = '<p>لا توجد عمليات</p>';
      let html = `<table border="1" style="width:100%;margin:auto"><tr><th>التاريخ</th><th>النوع</th><th>المبلغ</th><th>ملاحظة</th></tr>`;
      data.forEach((r,i)=>{
        html += `<tr onclick="deleteRow('${client}',${i})"><td>${new Date(r[0]).toLocaleDateString()}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td></tr>`;
      });
      html += '</table>';
      div.innerHTML = html;
    }

    async function deleteRow(client, rowIndex) {
      const pass = prompt('🔐 أدخل الرقم السري (1234) للحذف:');
      if (!pass) return;
      const res = await api({action:'deleteTransaction', client, rowIndex, password: pass});
      alert(res);
      getStatement();
    }

    loadClients();
  </script>
</body>
</html>
