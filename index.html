<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¯ÙŠÙˆÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
  <style>
    :root { --primary:#0b69ff; --card:#fff; --bg:#f2f6fb; --muted:#666;}
    body { margin:0; font-family: "Segoe UI", Tahoma, Arial; background:var(--bg); color:#222; }
    .wrap { max-width:820px; margin:18px auto; padding:12px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    h1 { font-size:20px; margin:0; }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    button.action { background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; font-size:15px; box-shadow:0 6px 16px rgba(11,105,255,0.15); }
    .card { background:var(--card); padding:14px; border-radius:12px; box-shadow: 0 4px 12px rgba(40,40,60,0.06); margin-top:14px; }
    select, input, textarea { width:100%; padding:10px; border-radius:8px; border:1px solid #e0e6f0; font-size:15px; box-sizing:border-box; }
    input[type=number] { text-align:center; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
    th,td { padding:8px 6px; border-bottom:1px solid #eee; text-align:center; }
    .btn-small { padding:6px 8px; border-radius:8px; border:none; cursor:pointer; }
    .btn-edit { background:#ffd54d; }
    .btn-del { background:#ff6b6b; color:#fff; }
    .muted { color:var(--muted); font-size:13px; }
    @media (max-width:520px){
      h1{font-size:18px}
      .row { gap:6px; }
      button.action { flex:1 1 48%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ’¼ Ø¥Ø¯Ø§Ø±Ø© Ø¯ÙŠÙˆÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>
      <div class="muted">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù: <strong>1234</strong></div>
    </header>

    <div class="row">
      <button class="action" onclick="showPage('addDebt')">â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ†</button>
      <button class="action" onclick="showPage('collectDebt')">ğŸ’µ Ù‚Ø¨Ø¶ Ø¯ÙŠÙ†</button>
      <button class="action" onclick="showPage('report')">ğŸ“„ ÙƒØ´Ù Ø­Ø³Ø§Ø¨</button>
      <button class="action" onclick="showPage('addClient')">ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
    </div>

    <div id="content" class="card">
      <p class="muted">Ø§Ø®ØªØ± Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„.</p>
    </div>
  </div>

<script>
  // ====== Ø¶Ø¹ Ø±Ø§Ø¨Ø· Web App Ø§Ù„Ù†Ø§ØªØ¬ Ù…Ù† Google Apps Script Ù‡Ù†Ø§ ======
  const API_URL = "https://script.google.com/macros/s/AKfycbw9IH0m7SRJyfgAV7UOjMvmcMsOl6xgtxmzE0MDK7Z086RLUicyUg7TvPw1n6df23Zo/exec";
  // ==========================================================

  async function api(payload){
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      try { return JSON.parse(text); } catch(e){ return {status:'error', message: text}; }
    } catch (err) {
      return {status:"error", message: "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: " + err.message};
    }
  }

  function showMessage(msg){
    document.getElementById('content').innerHTML = `<p class="muted">${msg}</p>`;
  }

  async function getClients(){
    const res = await api({action:"getClients"});
    if (res.status !== 'success') return [];
    return res.data || [];
  }

  async function showPage(page){
    const content = document.getElementById('content');
    content.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
    if (page === 'addClient'){
      content.innerHTML = `
        <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
        <input id="clientName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø«Ù„Ø§Ù‹: Ù…ØªØ¬Ø± Ø§Ù„Ø¨Ø¯Ø±)">
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="action" onclick="addClient()">Ø¥Ø¶Ø§ÙØ©</button>
          <button class="btn-small" onclick="showMessage('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      `;
      return;
    }

    if (page === 'addDebt' || page === 'collectDebt'){
      const clients = await getClients();
      if (!clients || clients.length === 0){
        content.innerHTML = `<p class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡. Ø£Ø¶Ù Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.</p>`;
        return;
      }
      const options = clients.map(c=>`<option value="${escapeHtml(c[0])}">${escapeHtml(c[0])}</option>`).join('');
      content.innerHTML = `
        <h3>${page==='addDebt'?'Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ†':'Ù‚Ø¨Ø¶ Ø¯ÙŠÙ†'}</h3>
        <label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <select id="clientSelect">${options}</select>
        <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <input id="amount" type="number" inputmode="numeric" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙÙ‚Ø·">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="note" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©"></textarea>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="action" onclick="submitDebt('${page}')">${page==='addDebt'?'Ø¥Ø¶Ø§ÙØ©':'Ù‚Ø¨Ø¶'}</button>
          <button class="btn-small" onclick="showPage('report')">Ø±Ø¬ÙˆØ¹</button>
        </div>
      `;
      return;
    }

    if (page === 'report'){
      const clients = await getClients();
      if (!clients || clients.length === 0) {
        content.innerHTML = `<p class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>`;
        return;
      }
      const list = clients.map(c => {
        const name = escapeHtml(c[0] || "");
        const amt = c[1] || 0;
        return `<li style="margin-bottom:8px"><button class="btn-small" style="width:100%;text-align:right;padding:10px" onclick="showClient('${name}')">${name} â€” ${amt}â€¬</button></li>`;
      }).join('');
      content.innerHTML = `<h3>ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</h3><ul style="list-style:none;padding:0">${list}</ul>`;
      return;
    }
  }

  // ===== Add client =====
  async function addClient(){
    const name = document.getElementById('clientName').value.trim();
    if (!name) { alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"); return; }
    showMessage("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...");
    const res = await api({action:"addClient", name});
    if (res.status === 'success') {
      alert(res.message || "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
      showPage('report');
    } else {
      alert(res.message || "Ø­Ø¯Ø« Ø®Ø·Ø£");
      showPage('addClient');
    }
  }

  // ===== Add / Collect debt =====
  async function submitDebt(page){
    const client = document.getElementById('clientSelect').value;
    const amount = document.getElementById('amount').value;
    const note = document.getElementById('note').value;
    if (!client) { alert("Ø­Ø¯Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„"); return; }
    if (!amount || Number(amount) <= 0) { alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­"); return; }
    showMessage("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...");
    const action = (page === 'addDebt') ? 'addDebt' : 'collectDebt';
    const res = await api({action, client, amount, note});
    if (res.status === 'success') {
      alert(res.message || "ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
      showPage('report');
    } else {
      alert(res.message || "Ø­Ø¯Ø« Ø®Ø·Ø£");
      showPage('report');
    }
  }

  // ===== Show client details =====
  async function showClient(name){
    const content = document.getElementById('content');
    showMessage("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");
    const res = await api({action:"getClientDetails", client: name});
    if (res.status !== 'success') { alert(res.message || "Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }
    const rows = res.data || [];
    if (rows.length === 0) {
      content.innerHTML = `<h3>Ø¹Ù…Ù„ÙŠØ§Øª ${escapeHtml(name)}</h3><p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</p><div style="margin-top:8px"><button class="btn-small" onclick="showPage('report')">Ø±Ø¬ÙˆØ¹</button></div>`;
      return;
    }

    let rowsHtml = rows.map((r,i)=>{
      const type = escapeHtml(r[0]||"");
      const amount = escapeHtml(r[1]||"");
      const note = escapeHtml(r[2]||"");
      const date = escapeHtml(r[3]||"");
      return `<tr>
        <td>${type}</td>
        <td>${amount}</td>
        <td style="text-align:right">${note}</td>
        <td>${date}</td>
        <td>
          <button class="btn-small btn-edit" onclick="editRow('${escapeJs(name)}', ${i})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn-small btn-del" onclick="deleteRow('${escapeJs(name)}', ${i})">Ù…Ø³Ø­</button>
        </td>
      </tr>`;
    }).join('');

    content.innerHTML = `
      <h3>Ø¹Ù…Ù„ÙŠØ§Øª ${escapeHtml(name)}</h3>
      <table>
        <thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>ØªØ§Ø±ÙŠØ®</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
        <tbody>${rowsHtml}</tbody>
      </table>
      <div style="margin-top:10px"><button class="btn-small" onclick="showPage('report')">Ø±Ø¬ÙˆØ¹</button></div>
    `;
  }

  // ===== Delete operation (with password check) =====
  async function deleteRow(client, index){
    const password = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ø­Ø°Ù:");
    if (password === null) return;
    showMessage("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...");
    const res = await api({action:"deleteOperation", client, index, password});
    if (res.status === 'success') {
      alert(res.message || "ØªÙ… Ø§Ù„Ø­Ø°Ù");
      showPage('report'); // ØªØ­Ø¯Ø« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    } else {
      alert(res.message || "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ÙƒÙ„Ù…Ø© Ø³Ø± Ø®Ø§Ø·Ø¦Ø© Ø£Ùˆ Ø®Ø·Ø£ Ø¢Ø®Ø±");
      showClient(client); // Ø¹Ø¯ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…ÙŠÙ„
    }
  }

  // ===== Edit operation UI =====
  async function editRow(client, index){
    // Ø§Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙ Ù„Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
    const res = await api({action:"getClientDetails", client});
    if (res.status !== 'success') { alert(res.message || "Ø®Ø·Ø£"); return; }
    const row = (res.data || [])[index];
    if (!row) { alert("Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©"); return; }

    const curType = row[0] || "Ø¯ÙŠÙ†";
    const curAmount = row[1] || "";
    const curNote = row[2] || "";

    document.getElementById('content').innerHTML = `
      <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ù„Ù€ ${escapeHtml(client)}</h3>
      <label>Ø§Ù„Ù†ÙˆØ¹</label>
      <select id="editType">
        <option ${curType === 'Ø¯ÙŠÙ†' ? 'selected' : ''}>Ø¯ÙŠÙ†</option>
        <option ${curType === 'Ù‚Ø¨Ø¶' ? 'selected' : ''}>Ù‚Ø¨Ø¶</option>
      </select>
      <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input id="editAmount" type="number" inputmode="numeric" value="${escapeHtml(curAmount)}">
      <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
      <input id="editNote" value="${escapeHtml(curNote)}">
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="action" onclick="saveEdit('${escapeJs(client)}', ${index})">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn-small" onclick="showClient('${escapeJs(client)}')">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    `;
  }

  async function saveEdit(client, index){
    const password = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:");
    if (password === null) return;
    const type = document.getElementById('editType').value;
    const amount = document.getElementById('editAmount').value;
    const note = document.getElementById('editNote').value;

    if (!amount || Number(amount) < 0) { alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­"); return; }

    showMessage("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„...");
    const res = await api({action:"editOperation", client, index, amount, note, type, password});
    if (res.status === 'success') {
      alert(res.message || "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
      showClient(client);
    } else {
      alert(res.message || "ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ÙƒÙ„Ù…Ø© Ø³Ø± Ø®Ø§Ø·Ø¦Ø© Ø£Ùˆ Ø®Ø·Ø£ Ø¢Ø®Ø±");
      showClient(client);
    }
  }

  // ===== helpers to escape HTML/JS injection =====
  function escapeHtml(str){
    if (!str && str!==0) return "";
    return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }
  function escapeJs(str){
    return String(str).replace(/'/g,"\\'");
  }

  // Ø¨Ø¯Ø§ÙŠØ©: Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  showPage('report');
</script>
</body>
</html>


